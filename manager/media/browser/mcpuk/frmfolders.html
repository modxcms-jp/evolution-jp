<!--
 * FCKeditor - The text editor for internet
 * Copyright (C) 2003-2005 Frederico Caldeira Knabben
 *
 * Licensed under the terms of the GNU Lesser General Public License:
 *              http://www.opensource.org/licenses/lgpl-license.php
 *
 * For further information visit:
 *              http://www.fckeditor.net/
 *
 * File Name: frmfolders.html
 *      This page shows the list of folders available in the parent folder
 *      of the current folder.
 *
 * File Authors:
 *              Frederico Caldeira Knabben (fredck@fckeditor.net)
 -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <link href="browser.css" type="text/css" rel="stylesheet">
    <script type="text/javascript" src="js/fckxml.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script language="javascript">

        var sActiveFolder;

        var bIsLoaded = false;

        var iIntervalId;

        var treeManager = {
            Init: function () {
                this.TreeRoot = document.getElementById('folderTree');
            },

            Clear: function () {
                if (!this.TreeRoot) {
                    return;
                }

                while (this.TreeRoot.firstChild) {
                    this.TreeRoot.removeChild(this.TreeRoot.firstChild);
                }
            },

            CreateNode: function (label, path, isActive) {
                var listItem = document.createElement('li');
                listItem.className = 'BrowserFolderTreeItem' + (isActive ? ' BrowserFolderTreeItem--active' : '');

                var link = document.createElement('a');
                link.href = '#';
                link.className = 'BrowserFolderTreeLink';
                link.appendChild(document.createTextNode(label));

                if (isActive) {
                    link.setAttribute('aria-current', 'page');
                    link.className += ' BrowserFolderTreeLink--current';
                } else {
                    link.onclick = function (event) {
                        if (event && event.preventDefault) {
                            event.preventDefault();
                        }

                        OpenFolder(path);
                        return false;
                    };
                }

                var children = document.createElement('ul');
                children.className = 'BrowserFolderTreeChildren';

                listItem.appendChild(link);
                listItem.appendChild(children);

                return {
                    node: listItem,
                    children: children
                };
            },

            Render: function (currentPath, childNodes) {
                if (!this.TreeRoot) {
                    return;
                }

                this.Clear();

                var treeList = document.createElement('ul');
                treeList.className = 'BrowserFolderTree';

                var pathParts = currentPath.split('/').filter(function (segment) {
                    return segment.length;
                });

                var isRootActive = pathParts.length === 0;
                var rootLabel = getResourceTypeLabel(oConnector.ResourceType);
                var rootNode = this.CreateNode(rootLabel, '/', isRootActive);
                treeList.appendChild(rootNode.node);

                var parentNode = rootNode;
                pathParts.forEach(function (part, index) {
                    var pathForPart = '/' + pathParts.slice(0, index + 1).join('/') + '/';
                    var isActive = index === pathParts.length - 1;
                    var childNode = treeManager.CreateNode(part, pathForPart, isActive);
                    parentNode.children.appendChild(childNode.node);
                    parentNode = childNode;
                });

                var targetContainer = parentNode.children;
                for (var i = 0; i < childNodes.length; i++) {
                    var sFolderName = childNodes[i].attributes.getNamedItem('name').value;
                    var nextNode = this.CreateNode(sFolderName, currentPath + sFolderName + '/', false);
                    targetContainer.appendChild(nextNode.node);
                }

                this.TreeRoot.appendChild(treeList);
            }
        };

        function CheckLoaded() {
            if (window.top.IsLoadedActualFolder
                && window.top.IsLoadedCreateFolder
                && window.top.IsLoadedUpload
                && window.top.IsLoadedResourcesList) {
                window.clearInterval(iIntervalId);
                bIsLoaded = true;
                SyncFrames(sActiveFolder);
            }
        }

        function SyncFrames(folderPath) {
            // Set the current folder in all frames.
            window.parent.frames['frmActualFolder'].SetCurrentFolder(oConnector.ResourceType, folderPath);
            window.parent.frames['frmCreateFolder'].SetCurrentFolder(oConnector.ResourceType, folderPath);
            window.parent.frames['frmUpload'].SetCurrentFolder(oConnector.ResourceType, folderPath);

            // Load the resources list for this folder.
            window.parent.frames['frmResourcesList'].LoadResources(oConnector.ResourceType, folderPath);
        }

        function OpenFolder(folderPath) {
            sActiveFolder = folderPath;

            if (!bIsLoaded) {
                if (!iIntervalId)
                    iIntervalId = window.setInterval(CheckLoaded, 100);
            } else {
                SyncFrames(folderPath);
            }

            LoadFolders(folderPath);
        }

        function LoadFolders(folderPath) {
            treeManager.Clear();
            oConnector.CurrentFolder = normalizeFolderPath(folderPath);
            oConnector.SendCommand('GetFolders', null, GetFoldersCallBack);
        }

        function GetFoldersCallBack(fckXml) {
            var oNode = fckXml.SelectSingleNode('Connector/CurrentFolder');
            var sCurrentFolderPath = normalizeFolderPath(
                oConnector.CurrentFolder || (oNode && oNode.attributes.getNamedItem('path').value)
            );

            var oNodes = fckXml.SelectNodes('Connector/Folders/Folder');
            treeManager.Render(sCurrentFolderPath, oNodes);
        }

        function SetResourceType(type) {
            oConnector.ResourceType = type;
            OpenFolder('/');
        }

        function getResourceTypeLabel(resourceType) {
            if (resourceType === 'files') {
                return 'Files';
            }

            if (resourceType === 'media') {
                return 'Media';
            }

            return 'Images';
        }

        function normalizeFolderPath(folderPath) {
            var normalized = folderPath || '/';

            if (normalized.charAt(0) !== '/') {
                normalized = '/' + normalized;
            }

            if (normalized.length > 1 && normalized.charAt(normalized.length - 1) !== '/') {
                normalized += '/';
            }

            return normalized;
        }

        window.onload = function () {
            treeManager.Init();

            if (oConnector.ResourceType.length == 0)
                SetResourceType('files');
            else
                OpenFolder('/');
        }
    </script>
</head>
<body class="mcpuk-browser FileArea BrowserBody BrowserBody--folders" bottomMargin="10" leftMargin="10" topMargin="10"
      rightMargin="10">
<div id="folderTree" class="BrowserFolderTreeRoot" aria-label="Folders" role="tree"></div>
</body>
</html>
