<!--
 * FCKeditor - The text editor for internet
 * Copyright (C) 2003-2005 Frederico Caldeira Knabben
 * 
 * Licensed under the terms of the GNU Lesser General Public License:
 * 		http://www.opensource.org/licenses/lgpl-license.php
 * 
 * For further information visit:
 * 		http://www.fckeditor.net/
 * 
 * File Name: frmupload.html
 * 	Page used to upload new files in the current folder.
 * 
 * File Authors:
 * 		Frederico Caldeira Knabben (fredck@fckeditor.net)
 * 		Grant French (grant@mcpuk.net)
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
    <link href="browser.css" type="text/css" rel="stylesheet"/>
    <script type="text/javascript" src="js/fckxml.js"></script>
    <script type="text/javascript" src="js/common.js"></script>
    <script language="javascript">

        var randomnumber = Math.floor(Math.random() * 65535);
        var refreshURL = '';
        var uploading = false;

        function SetCurrentFolder(resourceType, folderPath) {
            var sUrl = oConnector.UploadHandler + '?uploadID=' + randomnumber + '&Command=FileUpload';
            sUrl += '&Type=' + resourceType;
            sUrl += '&CurrentFolder=' + folderPath;
            sUrl += '&ExtraParams=' + oConnector.ExtraParams;
            document.getElementById('frmUpload').action = sUrl;

            oConnector.ResourceType = resourceType;
            oConnector.CurrentFolder = folderPath;
        }

        function setUploadMessage(message) {
            var messageEl = document.getElementById('eUploadMessage');
            if (!messageEl) return;

            if (message) {
                messageEl.innerHTML = message;
                if (messageEl.classList) {
                    messageEl.classList.add('is-visible');
                } else if ((' ' + messageEl.className + ' ').indexOf(' is-visible ') === -1) {
                    messageEl.className += ' is-visible';
                }
            } else {
                messageEl.innerHTML = '';
                if (messageEl.classList) {
                    messageEl.classList.remove('is-visible');
                } else {
                    messageEl.className = messageEl.className
                        .replace(/\bis-visible\b/, '')
                        .replace(/\s{2,}/g, ' ')
                        .replace(/^\s+|\s+$/g, '');
                }
            }
        }

        function OnSubmit() {
            if (document.getElementById('NewFile').value.length == 0) {
                alert('Please select a file from your computer');
                return false;
            }

            // Set the interface elements.
            setUploadMessage('Upload in progress, please wait... 0%');
            document.getElementById('filebox').style.display = "none";
            resetProgressBar();
            document.getElementById('progressbox').style.display = "inline";
            document.getElementById('btnUpload').disabled = true;

            uploading = true;
            setTimeout("GetUploadProgress()", 2000);

            return true;
        }

        function resetFileInput() {
            var fileInput = document.getElementById('NewFile');
            if (!fileInput) return;

            fileInput.value = '';

            // Some browsers (notably older versions of IE) don't allow clearing
            // the value property directly. In that case we recreate the element
            // so that selecting the same file again triggers the change event.
            if (fileInput.value) {
                var parent = fileInput.parentNode;
                var newInput = fileInput.cloneNode(true);
                parent.replaceChild(newInput, fileInput);
            }
        }

        function OnUploadCompleted(errorNumber, fileName) {
            uploading = false;

            // Reset the Upload Worker Frame.
            window.parent.frames['frmUploadWorker'].location = '';

            // Reset the upload form.
            //Sometimes causes IE to get itself in a mess (wont allow second upload)
            //document.getElementById('NewFile').reset() ;

            // Reset the interface elements.
            setUploadMessage('');
            document.getElementById('btnUpload').disabled = false;
            resetFileInput();

            var randomnumber = Math.floor(Math.random() * 65535);
            SetCurrentFolder(oConnector.ResourceType, oConnector.CurrentFolder);

            switch (errorNumber) {
                case 0 :
                    window.parent.frames['frmResourcesList'].Refresh();
                    document.getElementById('filebox').style.display = "inline";
                    document.getElementById('progressbox').style.display = "none";
                    break;
                case 201 :
                    window.parent.frames['frmResourcesList'].Refresh();
                    document.getElementById('filebox').style.display = "inline";
                    document.getElementById('progressbox').style.display = "none";
                    alert('A file with the same name is already available. The uploaded file has been renamed to "' + fileName + '"');
                    break;
                case 202 :
                    document.getElementById('filebox').style.display = "inline";
                    document.getElementById('progressbox').style.display = "none";
                    alert('Error, "' + fileName + '"');
                    break;
                default :
                    document.getElementById('filebox').style.display = "inline";
                    document.getElementById('progressbox').style.display = "none";
                    alert('Error on file upload. Error number: ' + errorNumber);
                    break;
            }
        }

        function resetProgressBar() {
            oProgressBar = document.getElementById('progress');
            var rows = oProgressBar.getElementsByTagName('tr');
            var row = rows[0];
            var cols = row.getElementsByTagName('td');
//	var label=document.getElementById("progress_label");

//	label.innerHTML="0%"
            for (i = 0; i < (cols.length - 1); i++) {
                cols[i].className = "progress_hollow";
            }
        }

        warned = false;

        function GetUploadProgressCallback(fckXml) {
            // Get the current folder path.

            if (!uploading) return false;

            var oNode = fckXml.SelectSingleNode('Connector/CurrentFolder');
            if (oNode == null) {
                if (!warned) {
                    alert("Invalid XML response from connector.[1]");
                    warned = true;
                }
                return false;
            }
            if ((oNode.attributes.getNamedItem('path') == null) || (oNode.attributes.getNamedItem('url') == null)) {
                if (!warned) {
                    alert("Invalid XML response from connector.[2]");
                    warned = true;
                }
                return;
            }

            var sCurrentFolderPath = oNode.attributes.getNamedItem('path').value;
            var sCurrentFolderUrl = oNode.attributes.getNamedItem('url').value;

            // Add the Folders.
            var oNode = fckXml.SelectSingleNode('Connector/Progress');
            if (oNode == null) {
                if (!warned) {
                    alert("Invalid XML response from connector.[3]");
                    warned = true;
                }
                return false;
            }
            if ((oNode.attributes.getNamedItem('max') == null) || (oNode.attributes.getNamedItem('value') == null)) {
                if (!warned) {
                    alert("Invalid XML response from connector.[4]");
                    warned = true;
                }
                return;
            }

            var iMax = oNode.attributes.getNamedItem('max').value;
            var iValue = oNode.attributes.getNamedItem('value').value;

            var oNode = fckXml.SelectSingleNode('Connector/RefreshURL');
            if (oNode == null) {
                if (!warned) {
                    alert("Invalid XML response from connector.[5]");
                    warned = true;
                }
                return false;
            }
            if ((oNode.attributes.getNamedItem('url') == null)) {
                if (!warned) {
                    alert("Invalid XML response from connector.[6]");
                    warned = true;
                }
                return;
            }
            refreshURL = oNode.attributes.getNamedItem('url').value;

            var oProgressBar = document.getElementById('progress');
            //var label=document.getElementById("progress_label");
            var rows = oProgressBar.getElementsByTagName('tr');
            var row = rows[0];
            var cols = row.getElementsByTagName('td');
            var percentage = Math.floor((iValue / iMax) * 100);
            setUploadMessage('Upload in progress, please wait.. ' + percentage + '%');

            //label.innerHTML=percentage+"%"
            for (i = 0; i < (cols.length - 1); i++) {
                if (((i + 1) * (100 / cols.length)) <= percentage) {
                    cols[i].className = "progress_filled";
                } else {
                    cols[i].className = "progress_hollow";
                }
            }

            if (uploading) getProgressTimer = setTimeout("GetUploadProgress()", 1000);
        }

        function GetUploadProgress() {
            if (uploading) oConnector.SendCommand('GetUploadProgress', 'uploadID=' + randomnumber + '&refreshURL=' + escape(refreshURL), GetUploadProgressCallback);
        }

        window.onload = function () {
            window.top.IsLoadedUpload = true;
        }
    </script>
</head>
<body class="mcpuk-browser BrowserBody BrowserBody--upload" bottomMargin="0" topMargin="0">
<form id="frmUpload" class="BrowserBodySection BrowserUploadForm" name="frmUpload" action="" target="frmUploadWorker"
      method="post" enctype="multipart/form-data" onsubmit="return OnSubmit();">
    <table class="BrowserTable" height="100%" cellSpacing="0" cellPadding="0" width="100%" border="0">
        <tr>
            <td class="BrowserUploadLayout" nowrap>
                <div id="eUploadMessage" class="BrowserUploadMessage" aria-live="polite"></div>
                <table class="BrowserTable BrowserUploadTable" cellSpacing="0" cellPadding="0" width="100%" border="0">
                    <tr>
                        <td class="BrowserUploadCell BrowserUploadCell--field" width="100%">
                            <div id="filebox" class="BrowserUploadField">
                                <input id="NewFile" class="BrowserInput BrowserInput--file" name="NewFile"
                                       style="width: 100%; background-color: transparent;"
                                       onchange="document.frmUpload.submit();" type="file">
                            </div>
                            <div id="progressbox" class="BrowserProgressBox" style="display: none;">
                                <table id="progress" class="progress_bar BrowserProgress">
                                    <tr>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                        <td class="progress_hollow">&nbsp;</td>
                                    </tr>
                                </table>
                                <!--<div id="progress_label"></div>-->
                            </div>
                        </td>
                        <td class="BrowserUploadCell BrowserUploadCell--button" nowrap>&nbsp;<input id="btnUpload" class="BrowserButton BrowserButton--hidden" type="submit" value="Upload"></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</form>
</body>
</html>
