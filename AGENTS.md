# 開発ガイドライン

このドキュメントは、このリポジトリにおけるAI駆動実装のローカル判断基準として最上位に扱う。

AIは実装前に必ずこのドキュメントを参照し、理解した上で「AGENTS.mdを読みました」と宣言して作業を進める。

## 基本原則

SOLID / KISS / YAGNI / DRY / PIE / SSOT を遵守する。

---

## 判断優先順位（迷ったらこれを守る）

1. **設計の健全性を最優先**（改善できるなら改善する。既存実装が不適切なら是正する）
2. **SSOTを壊さない**（責務分散・重複ロジックを作らない）
3. **セキュリティとエスケープは実行直前で担保**
4. **キャッシュ整合性を維持**
5. 局所最適よりも「システム全体の進化」を優先

---

## 重要方針

* 実装は既存パターンを調査して整合させる。ただし不適切な既存実装は改善を優先する。
* 局所的な独自方式の導入は禁止し、横断適用可能な設計で改善する。
* セキュリティ（特にDBエスケープ）は実行直前で担保する。
* キャッシュ整合性、イベント/フック整合性を破壊しない。
* レビュー・コミュニケーションは日本語を基本とする。

---

## 禁止事項（要点）

* `$modx` やスーパーグローバルへの直接アクセス
* 変数代入時の早期エスケープ
* フック位置・キャッシュ無効化条件の無視
* 小規模修正への新アーキテクチャ持ち込み

---

## 移行ルール（v1.3.0+）

### フロントエンド

* jQuery 禁止 → Vanilla JS (ES6+)
* frame/iframe 禁止

### データベース

* `db()` ヘルパー厳守
* 生SQL自粛

### CLI / ログ

* 管理機能は CLI 実行可能
* ログはコンテキスト配列形式

---

## ドキュメントマップ

`assets/docs/` 配下を必ず参照する。

| ドキュメント                  | 主題     |
| ----------------------- | ------ |
| `development-standards.md` | 実装規約（ヘルパー・入力値取得・DB・スタイル・ログ） |
| `commit-message-guidelines.md` | コミットメッセージ規約 |
| `architecture.md`       | 処理フロー  |
| `template-system.md`    | タグ解析   |
| `events-and-plugins.md` | イベント   |
| `cache-mechanism.md`    | キャッシュ  |
| `.agent/roadmap.md`     | ロードマップ |
| `global-settings.md`    | 設定追加   |
| `core-issues.md`        | コア課題   |

---

## 実装時の必須確認

* 既存実装を `rg` で調査し、重複実装を作らない。
* `architecture.md` で影響範囲を整理する。
* `cache-mechanism.md` と `events-and-plugins.md` で整合性を確認する。
* DocumentParser関連は `manager/includes/document.parser.class.inc.php` のどの段階に影響するかを明示する。

---

## ファイル管理

* メディア: `{rb_base_dir}` 配下
* テンプレート: `assets/templates/`
* 一時領域: `temp/`

除外: `assets/plugins/*/tinymce/` 以下は参照不要

---

## ドキュメント運用

* AGENTS.md は **判断基準とポインタのみ** を記載する。
* ExecPlan は `.agent/plans/` に格納
* ロードマップは `.agent/roadmap.md`

---

## 肥大化防止ポリシー

AGENTS.md は「原則・優先順位・禁止事項・参照先」のみを保持し、手順や詳細仕様は必ず `assets/docs/` に分離する。
