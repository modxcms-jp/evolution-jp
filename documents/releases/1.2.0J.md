# Evolution CMS JP Edition 1.2.0J リリースノート

## 概要
Evolution CMS JP Edition 1.2.0J は、前バージョンから続く PHP 8 対応を一段と深め、実運用で安心して切り替えられることを最優先に仕上げた大型アップデートです。PHP 7.4 までは Notice で済んでいた挙動が PHP 8 で Warning や Error になってしまうケースを洗い直し、DocumentParser を中心に発火順序やログの出力を整理しました。従来はグローバル設定を「全て無視」にする力技で一時的に凌ぐしかありませんでしたが、1.2.0J ではスニペットやプラグインごとに PHP エラーレベルを調整できるようになり、問題のある要素だけを安全に切り分けながら段階的に修正できます。

設定面では `.env` による外部化を標準化し、UTF-8MB4 変換の導線も整備することで、ユーザーの安心感と日々の運用効率を両立しました。PHP 8 で迷いがちな運用も、今回の粒度の細かいエラーレベル制御によってスタート地点から安心して進められます。

## ユーザー向け注目ポイント

### PHP 8 への移行を現実的に
前回のリリースで進めていた PHP 8 対応をさらに掘り下げ、DocumentParser やサブシステムの未定義プロパティ、古い API への依存を解消しました。特に課題だったのは、PHP 7.4 までは Notice で済んでいたコードが PHP 8 で Warning/Error に昇格してしまう点です。今回からはスニペット・プラグイン単位で「どこまで検出するか」を切り替えられるようになりました。トラブルを起こす要素だけ一時的にレベルを緩め、動作を確保しつつ段階的に修正を進めてください。セキュリティを下げた状態を常用することは推奨されませんが、これまでよりも安全に移行期間を確保できます。

### 文字化けの不安なく、UTF-8MB4 へ
長年の懸念だった UTF-8MB4 変換の手順を整理し、主要テーブルを自動で判別する仕組みを用意しました。これにより、タツサキ・ハシゴダカ（「髙」などの異体字）や絵文字を登録したときに化けてしまう問題を抑えられます。インストール直後から UTF-8MB4 で構築したい場合も、既存サイトを後から変換したい場合も迷わず進められるガイドを提供しています。

### `.env` による設定の外部化
アプリケーション設定を `.env` にまとめられる Dotenv ローダーを新設しました。以下のようなファイルを用意しておけば、データベース接続情報やメール設定などをコードベースから切り離せます。

```dotenv
# database
DB_HOST=localhost
DB_DATABASE=evo_jp
DB_USERNAME=evo_user
DB_PASSWORD=change-me
TABLE_PREFIX=modx_

# application
MODX_BASE_URL=https://example.jp/
MAIL_FROM_ADDRESS=info@example.jp
```

インストーラーや各種スニペットからは `env()` ヘルパーで値を参照でき、環境ごとに異なる設定を安全に切り替えられます。既存の `config.inc.php` と併用しつつ、段階的に移行することも可能です。

### 管理画面の使い勝手を改善
日常的に触れるマネージャーの操作性を細かく見直しました。文書検索・ユーザー検索で未エスケープの入力が混ざっても壊れないよう SQL を整理し、ロール別の絞り込みも正確に動作します。ZIP パッケージの取り込みを ZipArchive ベースに更新したことで、大きめの拡張機能でもタイムアウトしにくくなりました。MCPUK ファイルブラウザーやフォーム配置などの細部も調整し、作業のひっかかりを取り除いています。

## セキュリティと信頼性の強化
- セッション検証や Cookie 属性の扱いを見直し、デバッグ情報が画面に漏れないよう整理しました。
- キャッシュ同期、ファイルアップロード、メール送信といった運用フローで null チェックやリトライ条件を追加し、PHP 8 系で顕在化していた警告を抑えています。
- サンプル `.htaccess` から古い記述を削除し、初期状態でも堅牢な構成に近づけました。

## PHP 8 時代の運用ガイド
1. まずはテスト環境で「PHP エラーの検出レベル」を高めに設定し、Warning や Notice の発生源を洗い出してください。
2. 問題のあるスニペットやプラグインだけ、今回の新機能でエラーレベルを一時的に緩めます。動作を確保したうえで、コードの修正を進めてください。
3. 修正が完了した要素から順に検出レベルを元へ戻し、最終的にはグローバル設定も「全て検出」に近づけるのが理想です。
4. エラーを握りつぶしたまま運用し続けることは、セキュリティリスクにつながります。長期的には PHP 8 を前提とした最新の書き方にアップデートしてください。

## 開発者向けの主な変更
- DocumentParser やサブパーサーで未定義プロパティを初期化し、`@` 演算子に頼らずに実行できるよう整理しました。
- `mb_strftime()` 依存を減らし、`DateTime` ベースでロケールを意識した日時表記を扱えるようにしています。
- `config()`・`entity()`・`doc()` などのヘルパー整備が進み、グローバル変数を直接触らなくても主要情報を取得しやすくなりました。
- PHPMailer や FileUpload など外部コンポーネント周辺の古い互換コードを削除し、PHP 8.4 でも問題なく動作するよう更新しています。
- アップグレードスクリプトを刷新し、権限テーブルやプラグイン設定の差分を自動で補うようになりました。既存環境の構成を保ちながら安全に移行できます。

## 廃止・互換性に関する注意
- 旧来の `mysql` ドライバーを削除し、データベースは `mysqli` 固定になりました。PHP 側の拡張が有効になっているかご確認ください。
- Safe Mode 互換のために残っていた `set_time_limit()` などの古いワークアラウンドを整理しています。独自スクリプトで同様の想定をしている場合は調整が必要です。
- `.env` を導入したことで、設定値はコードと環境ファイルの双方で管理する前提になりました。自動デプロイでは `.env` をリポジトリ外で保護する運用へ切り替えてください。

## アップデート手順と既知の注意事項
1. 本番適用前に PHP 8.4 相当のテスト環境で動作確認を行い、`config.inc.php` と `.env` の整合性を確認してください。
2. アップデート後は `fix_settings` ツールを実行し、権限テーブルやプラグイン設定に不足がないかチェックします。
3. UTF-8MB4 化を検討している場合は、アップデート後に新しいリストを使って `install/convert2utf8mb4.php` を実行してください。
4. キャッシュディレクトリ（`assets/cache/`）と `temp/` の書き込み権限が強化されています。適用後にパーミッションを再確認してください。

現代的な運用・開発フローに合わせた改善を随所に盛り込みながら、旧来の資産も丁寧に引き継げるよう配慮したのが 1.2.0J です。Evolution CMS JP Edition を PHP 8 時代でも安心してご活用ください。
