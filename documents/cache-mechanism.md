# キャッシュメカニズム

## ページキャッシュ方式
- `DocumentParser::getCache()` は `core/cache/<uaType>/` 以下のファイルを読み込み、URL ハッシュ（タイプ 2）または `docid_<id>`（タイプ 1）でページを判定します。TTL の検証や管理画面セッションの除外、シリアライズ済みドキュメントオブジェクトの復元をここで行います。
- `postProcess()` はレンダー完了後にキャッシュを書き戻します。タイプ 1 はメタ情報とコンテンツをまとめて保存し、タイプ 2 は MIME タイプと生の出力を URI ハッシュで管理します。404 などのステータスはファイル名として反映されます。
- キャッシュはユーザーエージェントごとに `pages` / `pc` / `smartphone` / `tablet` / `mobile` といったバケットに分割され、必要に応じてディレクトリを生成します。

## 静的 HTML キャッシュ
- `get_static_pages()` は `temp/public_html/` の事前生成ファイルを配信し、動的パーサーの手前でレスポンスを返します。スニペットやプレースホルダーなど一部の要素は、必要に応じて最新の状態で評価される場合がありますが、通常は `parseDocumentSource()` は実行されません。

## サイトキャッシュインデックス
- `synccache::buildCache()` が設定・コンテンツマップ・要素キャッシュを再生成し、`config.siteCache.idx.php` やエイリアスマップ、ドキュメントマップ、要素別キャッシュをまとめて書き出します。`OnBeforeCacheUpdate` / `OnCacheUpdate` イベントでプラグインフックが提供されます。

## キャッシュクリア
- `DocumentParser::clearCache()` はドキュメント ID や `full`、`['target' => 'pagecache']` のようなオプションを受け取り、対象ページのキャッシュをユーザーエージェントバケット横断で削除します。その後 `synccache::emptyCache()` を呼び出してサイトキャッシュを再生成します。
- コンテンツや設定を変更する際は手動でファイルを削除せず、`evo()->clearCache()` を利用してください。

## TTL と失効
- `config('cache_ttl')` が設定されている場合、`getCache()` がファイルの更新時刻を比較し、期限切れのキャッシュを自動削除します。次のアクセスで再生成が行われます。
- 公開・非公開の切り替えは `cacheRefreshTime` を更新し、`updatePublishStatus()` によってキャッシュ状態が再確認されます。
