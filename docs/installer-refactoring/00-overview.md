# インストーラリファクタリング計画

## 概要

Evolution CMSのインストーラ（`install/`ディレクトリ）の構造が複雑化しているため、段階的なリファクタリングとセキュリティ・UX改善を実施します。

## 現状の問題点

### 1. 責任の分離不足

- **インストールとアップグレードが混在**
  - `instprocessor.php:38-65` - 分岐処理が複雑
  - すべてのprocessorで同様のパターンが繰り返される
  - コードの可読性が低く、テストが困難

### 2. グローバル変数の多用

- `instprocessor.php:7-13` - 6つのグローバル変数
- すべてのprocessorで同じグローバル変数を参照
- 依存関係が不明瞭、副作用の追跡が困難

### 3. セッション依存度が高すぎる

- すべてのactionとprocessorがセッションに直接依存
- 単体テストが不可能
- CLI実行やバッチ処理への拡張が困難

### 4. コアDB機能とインストーラロジックの混在

- `index.php:16-17` - DocumentParserをインスタンス化
- コアの`db()`ヘルパーに直接依存
- インストーラの独立性が低い

### 5. エラーハンドリングの不統一

- 場所によってHTMLを直接echo、エラーカウント、exit()など様々
- エラーの捕捉と処理が困難
- ユーザーへのエラーメッセージが不統一

### 6. 長大な関数と単一責任原則の違反

- `functions.php` - 559行のヘルパー関数集
- `instprocessor.php` - 251行が1ファイル
- `actions/summary.php` - 299行

### 7. ディレクトリ/ファイル構成の問題

- ロジックとビューが混在
- クラス化されていない（手続き型）
- 名前空間なし、自動ロードなし

### 8. テストの困難性

- すべてのファイルでセッション、グローバル変数、DB直接アクセスに依存
- 副作用が多い
- 依存性注入がない

### 9. HTMLとロジックの混在

- すべてのprocessorでHTMLを直接echo
- ビューの変更が困難

### 10. セキュリティ上の問題

- **誰でもアップグレードを実行できる**（認証なし）
- CSRF保護なし
- パスワードがMD5でハッシュ化（`sqlParser.class.php:62`）

## リファクタリングの目標

1. **インストールとアップグレードの完全分離**
2. **クラスベースアーキテクチャへの移行**
3. **依存性注入の導入**
4. **ディレクトリ構造の再編成**
5. **コアから独立したDB抽象化レイヤー**
6. **セキュリティの強化**
7. **UXの改善**
8. **テスト可能な構造**

## ドキュメント構成

- [01-refactoring-plan.md](./01-refactoring-plan.md) - 段階的リファクタリング計画
- [02-security-improvements.md](./02-security-improvements.md) - セキュリティ改善提案
- [03-ux-improvements.md](./03-ux-improvements.md) - UX改善提案
- [04-directory-structure.md](./04-directory-structure.md) - 新しいディレクトリ構造
- [05-migration-guide.md](./05-migration-guide.md) - 移行ガイド

## スケジュール

全体で10-15週を想定：

| Phase | 期間 | 内容 |
|-------|------|------|
| 1 | 1-2週 | 基礎構築（ディレクトリ構造、オートローダー） |
| 2 | 1週 | Database層の移行 |
| 3 | 2週 | Installer/Upgraderの分離 |
| 4 | 1-2週 | Assetインストーラの移行 |
| 5 | 1-2週 | Controller/Viewの分離 |
| 6 | 1週 | Session抽象化 |
| 7 | 1週 | Validator分離 |
| 8 | 1-2週 | functions.php解体 |
| 9 | 1週 | テスト |
| 10 | 1週 | ドキュメント |

## 優先順位

### 高優先度（セキュリティ）

1. アップグレード時の認証
2. CSRF保護
3. SQLインジェクション対策強化（プリペアドステートメント）
4. パスワードハッシュのphpass移行
5. インストールディレクトリの自動削除

### 中優先度（UX）

6. 進捗表示の改善
7. バックアップ機能
8. エラーメッセージの改善
9. システム要件チェックの強化

### 低優先度（運用性）

10. ログ記録
11. ロールバック機能
12. CLI対応
13. アップグレードパス検証
