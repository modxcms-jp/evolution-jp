# テンプレートと要素の解析手順

## テンプレート解決

- `_getTemplateCode()` がテンプレート継承を辿り、`@FILE` などのバインディングを処理しながら親テンプレートのプレースホルダーを展開します。
- テンプレート変数（TV）はドキュメント取得時に同時に読み込まれ、`[*tvName*]` のようなトークンはコアフィールドと同じパスで評価されます。

## 解析パス

`parseDocumentSource()` は MODX タグがなくなるまで定められた順序で繰り返し実行されます。条件タグ、インラインフィルター、TV、システム設定、チャンク、スニペット、プレースホルダー、URL の順で解析され、各周回で `OnParseDocument` イベントが発火します。

## 要素種別

- **ドキュメントフィールド / TV**: `mergeDocumentContent()` がフィールド参照やフォールバック（`field|altField`）、親参照（`field@parent`）、モディファイアチェーン、`@` バインディングを処理します。TV の配列値は既定で `tvProcessor()` によって整形されます。
- **システム設定**: `mergeSettingsContent()` が `[(setting)]` を置換し、モディファイアにより算出値を提供します。
- **チャンク**: `mergeChunkContent()` がチャンク本文を読み込み、パラメータ付きプレースホルダーや入れ子のタグを再帰的に解析します。リテラルセクションは尊重されます。
- **プレースホルダー**: `mergePlaceholderContent()` がネストしたタグを先に評価し、その後 `[+placeholder+]` を置換します。スニペットやプラグインが投入した値が対象です。
- **スニペット**: `evalSnippets()` が `[[Snippet?param=value]]` をトークナイズし、プロパティ読込後に PHP を実行します。`[[!Snippet]]` は非キャッシュとして扱われ、`parseNonCachedSnippets()` によりランタイム評価へ書き換えられます。

## 条件タグとコメント

- 条件ブロック（`<@IF>` / `<!--@IF-->`）は `mergeConditionalTagsContent()` により正規化され、`_parseCTagCMD()` が内部の MODX タグも含めて判定します。
- `<!--@IGNORE-->` や `<!--@MODX:...-->` で囲まれたコメントタグも同じ解析ループで処理され、必要なパスでのみ展開されます。

## 出力調整

- `outputContent()` が登録済みのスクリプトやインラインコードを挿入し、残留する MODX マーカーを整理した上で `OnWebPagePrerender` を発火します。
- ベンチマーク用プレースホルダー（`[^q^]` など）は `mergeBenchmarkContent()` により最終段階で埋め込まれます。
