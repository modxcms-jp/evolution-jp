# Evolution JP PHP8対応版 リリース情報

## 重要：PHP8完全対応と技術的負債の解消

**Evolution JPがPHP8に完全対応**しました。PHP8.0、8.1、8.2、8.3環境で安定動作します。

**段階的な移行が可能**: 現在PHP7.4をご利用の場合、まず**PHP7.4環境のままEvolution JPをアップグレード**して動作確認できます。その後、落ち着いてPHP8へ移行すれば安全です。今回のバージョンはPHP7.4でも動作するよう調整しています。

長年積み重ねられてきた技術的負債を解消し、次の10年を見据えたモダンで安全、メンテナンスしやすいCMSになりました。数百箇所のコード改善により、安定性とセキュリティを大幅に向上させています。

### 開発規模
- **882コミット**の開発作業
- **782ファイル**を変更
- **44,588行を追加、30,784行を削除**（実質約13,800行の増加）

---

## 一般ユーザー向け情報

### 管理画面テーマの充実

7種類から好みに応じて管理画面のデザインを選択できます：

1. **AuroraFlow** - モダンで洗練されたデザイン（デフォルト）
2. **RevoClassic** - RevoStyleの系譜を引き継ぎ、最近のパソコンに適したサイズ感に改良
3. **RevoStyle** - 従来のRevoStyleデザインを維持（次バージョンで廃止予定）
4. **SoftSlate** - ビジネスライクで無難なデザイン、業務システム向け
5. **RubberWhite** - シンプルなホワイトテーマ
6. **SakuraFlow** - 個性的な和風デザイン
7. **AromaHop** - 個性的なデザイン（SakuraFlowと姉弟的）

### TinyMCEプラグインを最新化

- **TinyMCE7へアップデート** - 最新の高機能エディタ
- **TinyMCE3を廃止** - 古いバージョンを削除

### MCPUKファイルブラウザの改善

長年ほとんど変わっていなかったMCPUKファイルブラウザを大幅に改善しました：

- **フォルダツリー表示** - フォルダ階層が見やすくなりました
- **デザインの統一** - 管理画面のテーマに合わせたスタイル
- **長いファイル名に対応** - 文字が途切れず表示されます
- **操作ボタンの改善** - より直感的に

### UTF-8MB4完全対応

データベースの文字コードを**UTF-8MB4に簡単に変換**できます。

#### UTF-8MB4で何ができる？
- **絵文字が使える** - 😀🎉💡などの絵文字をコンテンツに使用可能
- **異体字に対応** - 「﨑（タツサキ）」「髙（ハシゴダカ）」などの旧字体・異体字を正しく保存
- **多言語対応の強化** - より広範囲のUnicode文字に対応

#### インストーラで簡単変換
インストーラに**データベース文字コード変換機能**を実装しました。既存のデータベースを安全にUTF-8MB4に移行できます。テーブルやカラムの照合順序も自動で変更します。

### インストーラの改善

- **エラーログの出力機能** - インストール中のエラー詳細を `install/temp/install.log` に記録。今まではエラーが起きても詳細情報が得られず問題解決に時間がかかっていましたが、ログファイルで原因を特定できるようになりました

### 古いブラウザ対応を廃止

- **Internet Explorer対応を完全廃止**
  - IE11を含むすべてのIEサポート終了
  - モダンブラウザ（Chrome、Firefox、Edge、Safari）での利用を推奨
  - これにより動作が軽快に、メンテナンスも容易になりました

### セキュリティ強化

- **CSRF（クロスサイトリクエストフォージェリ）対策を全面導入**
  - マルチタブ対応の洗練された実装（最大10トークンを同時管理）
  - 管理画面のすべてのフォーム送信で検証
  - 非推奨だったReferer検証を廃止
- **ファイルアップロード時のセキュリティ改善**
  - 不正なファイル名を自動的にサニタイズ
- **入力値の安全な取得**
  - `$_GET`, `$_POST`, `$_REQUEST`の直接アクセスを廃止
  - 安全なヘルパー関数（`getv()`, `postv()`, `anyv()`）に統一

### 新機能

- **イベントログのエクスポート機能** - ログをテキストファイルで保存可能
- **メール送信ログ機能（オプション）** - MODxMailerの送信履歴を記録
- **環境変数対応（.env）** - dotenvファイルでデータベース接続情報などを管理可能。本番・ステージング・テスト環境を簡単に切り替えられます
  **注意**: サーバー設定によっては.envファイルが外部から閲覧可能になる場合があります。Webサーバーの設定で`.env`ファイルへのアクセスを必ず拒否してください
- **バージョンミスマッチ検出** - データベースとファイルのバージョン不整合を自動検出
- **プレビュー機能の強化** - トークンベースでより安全なプレビュー表示

### 安定性の向上

**数百箇所のエラーを修正し、安定性が大幅に向上しました：**

- PHP8環境でのエラー・警告を徹底的に修正
- Dittoスニペットの安定性向上
- WebLoginプラグインの改善
- リソース管理画面のエラー修正
- キャッシュ処理の最適化

### 動作環境の変更

**推奨環境：**
- PHP 8.0 / 8.1 / 8.2 / 8.3
- MySQL 5.7以上 / MariaDB 10.2以上
- モダンブラウザ（Chrome、Firefox、Edge、Safari最新版）

**非対応：**
- PHP 7.x以下
- Internet Explorer（全バージョン）

---

## エンジニア向け情報

### コードベースのモダン化

#### PHP8対応の詳細
- 動的プロパティの明示的宣言（PHP8.2対応）
- Null合体演算子(`??`)の活用による安全な配列アクセス
- 非推奨関数の置き換え（`strftime` → `mb_strftime`等）
- 型安全性の強化
- 配列構文の統一（`array()` → `[]`）

#### JavaScriptのモダン化
- ES6+対応：`var` → `let`/`const`
- クラス構文の導入（WebFXTabPane等）
- `addEventListener`への完全移行
- アロー関数の活用
- MooToolsライブラリの完全削除 → ネイティブAPI実装

#### コード品質向上
- トレイトの導入（コード再利用性向上）
- アクセス修飾子の明示化
- ヘルパー関数の統一（`getv()`, `postv()`, `anyv()`等）
- 不要コードの大規模削除
- コードスタイルの統一

### アーキテクチャ改善

#### セキュリティアーキテクチャ
- **CSRF保護システム**: セッションベースのマルチトークン管理（FIFOキュー方式）
- **入力値の統一的な取得**: `getv()`, `postv()`, `anyv()`ヘルパー関数
- **Referer検証の廃止**: `validate_referer`設定を削除

#### キャッシュシステム
- `MODX_CACHE_PATH`定数による一元管理
- キャッシュリフレッシュロジックの改善
- URL→ドキュメントIDマッピングの最適化

#### データベース
- MySQL拡張を完全削除（MySQLi専用）
- 接続処理の改善（タイムアウト、エラーハンドリング）
- `event_log`テーブルのsourceカラム拡大
- UTF-8MB4変換の自動化（インストーラで実行）

#### インストーラ
- **設定修正のPHP化**: `fix_settings.sql` → `fix_settings.php`
- **ログ機能**: `log_install_event()`でインストールプロセスを追跡
- **セッション検証**: `validateSessionValues()`で必須項目チェック

#### テーマシステム
- CSS変数の大規模導入（150箇所以上）
- 論理プロパティによるRTL対応
- 共通リソースの集約（`manager/media/style/common/`）
- テーマ共通化によるメンテナンス性向上

### 開発ドキュメント

- `AGENTS.md` - 開発ガイドライン（日本語）
- アーキテクチャドキュメント（キャッシュメカニズム、イベント統合、パーサー処理）
- Data URI自動ファイル化機能のドキュメント（実験的機能）

### 技術的負債の解消

今回のリリースの象徴的テーマです。長年積み重ねられてきた技術的負債を解消し、持続可能な開発体制を構築：

- **レガシーコードの大規模削除**
  - IE対応コード（X-UA-Compatible等）の完全削除
  - MooToolsライブラリの削除とネイティブAPI実装
  - 非推奨・廃止予定関数の置き換え

- **PHP8非互換コードの全面修正**（数百箇所）
  - 動的プロパティ、未定義配列キー、型エラー等
  - 将来のPHPバージョンへの対応基盤を構築

- **セキュリティ脆弱性の修正**
  - CSRF対策、入力サニタイズ等

- **エラーハンドリングの包括的改善**
  - Null安全性の向上、例外処理の整備

---

## アップグレード時の注意事項

### 推奨アップグレード手順（PHP7.4ユーザー向け）

現在PHP7.4をご利用の場合、以下の段階的な移行を推奨します：

1. **まずPHP7.4環境のままEvolution JPをアップグレード**
   - 今回のバージョンはPHP7.4でも動作します
   - 現在の環境でアップグレードして動作確認できます

2. **動作確認後、PHP8へ移行**
   - Evolution JPの動作を確認してから
   - サーバーのPHPバージョンを8.0以上にアップグレード
   - 段階的に移行することでリスクを軽減できます

### 必須の確認事項

1. **バックアップの取得**
   - データベースとファイルの完全バックアップを必ず取得してください

2. **ブラウザ要件の確認**
   - Internet Explorerは使用できなくなりました
   - モダンブラウザ（Chrome、Firefox、Edge、Safari）をご利用ください

3. **UTF-8MB4への移行（強く推奨）**
   - インストーラの文字コード変換機能を利用してください
   - 絵文字、異体字（﨑、髙など）に対応できます
   - 将来的な文字化けトラブルを防止できます

---

このアップデートにより、Evolution JPは次の10年を見据えた、モダンで安全、メンテナンスしやすいCMSになりました。
